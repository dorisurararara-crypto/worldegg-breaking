너는 내 코드를 “앵커 기준”으로 수정해라.
⚠️ 일괄치환(occurrence 개수 기대) 방식 금지. 반드시 아래 앵커(주변 코드 문자열)로 위치를 찾아 “그 자리”에만 수정/삽입해라.
목표: 월 4~5만원대(관전 10만) 비용 안정화 + 장시간 방치 UX 개선 + 상태 동기화/경합 버그 예방.

================================================================================
[1] 프론트: 관전자(visible) 기본 폴링 20초 → 30~60초로 상향
================================================================================
파일: egg-breaker/src/hooks/useGameState.js

앵커 A(필수):
- 파일 안에서 “R2 성공” 또는 “R2 fetch success” 이후 nextDelay를 잡는 구간을 찾아라.
- 특히 아래 중 하나를 포함하는 줄 근처를 찾아 수정:
  - `nextDelay = 20000`
  - 또는 `const baseDelay = 20000`
  - 또는 `POLL_MS_ACTIVE = 20000` 같은 상수

수정 요구:
- “visible + spectator(connected=false)” 기본 폴링을 최소 30초로 올려라. (권장 45초)
- 예시(권장값): 45000ms (45초)
- 기존 jitter 로직은 유지하되, visible 구간은 ±20% 정도면 충분.

반영 방식(앵커 기준):
- `nextDelay = 20000;` 라인이 있으면 그 라인을 `nextDelay = 45000;` 로 교체.
- 만약 상수로 정의돼 있으면 `20000`을 `45000`으로 교체.
- “PLAYING일 때만 더 자주” 같은 적응형이 이미 있으면, 그 로직의 최소값만 30초 이상으로 올려라.

================================================================================
[2] 프론트: Hard-stop(절전 모드) 조건을 visible/hidden로 분리 (UX 개선)
================================================================================
파일: egg-breaker/src/hooks/useGameState.js

앵커 B(필수):
- 아래 같은 조건을 찾는다:
  - `idleTime > 2 * 60 * 60 * 1000`
  - 또는 `IDLE_HARD_STOP_MS`
  - 또는 `if (idleMs > ... ) { setIsPollingPaused(true) ... }`

현재 문제:
- visible 상태에서 2시간 인터랙션이 없으면(사용자가 가만히 보기만 해도) 절전이 걸릴 수 있음.

수정 요구:
- hidden일 때만 2시간 hard-stop 유지
- visible일 때는 더 느슨하게(권장 8시간) hard-stop 적용
  - hiddenHardStopMs = 2h
  - visibleHardStopMs = 8h

반영 방식(앵커 기준):
- `document.visibilityState === "hidden"` (또는 `isHidden`) 분기 근처에 아래처럼 분리:
  - `const hardStopMs = isHidden ? 2h : 8h;`
  - 기존 `idleTime > 2h` 비교는 `idleTime > hardStopMs`로 바꿔라.

================================================================================
[3] 백엔드: cleanupInactiveSessions()에서 상태 변화 시 broadcastState까지 호출
================================================================================
파일: egg-backend/src/gameDO.ts

앵커 C(필수):
- `cleanupInactiveSessions()` 함수(또는 비슷한 이름) 정의를 찾아라.
- 그 안에서 아래 중 하나가 보일 것이다:
  - `this.broadcastQueueUpdate();`
  - 또는 `removedPlayers` / `removedQueue` / `removedSpectators` 같은 카운트 변수
  - 또는 `if (removed > 0) { ... }`

수정 요구:
- cleanup이 실제로 무엇인가를 제거/정리해서 “상태가 바뀌었으면”
  - `this.touchState();` 또는 `this.stateChanged = true;` 를 확실히 세팅
  - `this.broadcastState();` 를 1회 호출
- 단, 매 tick마다 무조건 broadcast하지 말고 “변화가 있었을 때만” 호출

반영 방식(앵커 기준):
- `this.broadcastQueueUpdate();`가 있는 조건 블록을 찾고,
  그 **바로 아래**에 아래를 추가:
  - `this.broadcastState();`
- 그리고 변화가 있었던 조건 블록 안에서 `this.touchState();`(없으면 `this.stateChanged = true; this.gameState.lastUpdatedAt = Date.now();`)도 함께 보장

================================================================================
[4] 백엔드: R2 업로드 stateChanged 경합(누락) 방지 - stateVersion 도입
================================================================================
파일: egg-backend/src/gameDO.ts

앵커 D-1(필수, 필드 추가):
- class GameDO 내부 필드 선언들(예: `private stateChanged = false;` 근처)을 찾아라.

수정:
- 아래 필드 추가:
  - `private stateVersion = 0;`

앵커 D-2(필수, 변경 시 증가):
- `touchState(` 메서드가 있으면 그 메서드 내부를 수정해라.
  - 앵커: `private touchState` 또는 `touchState(`

수정:
- touchState 내부에서 stateChanged=true와 함께:
  - `this.stateVersion++;` 를 추가

(만약 touchState가 없고 여기저기 `lastUpdatedAt` 직접 대입이면)
- lastUpdatedAt 갱신하는 공용 헬퍼(touchState)를 먼저 만들고,
- lastUpdatedAt 갱신은 반드시 touchState를 쓰게 해라.
(기존에 touchState가 이미 있으면 그대로 활용)

앵커 D-3(필수, 업로드 게이트 수정):
- `async uploadStateToR2()` 함수 정의를 찾아라.
- 그 안에 아래 같은 패턴이 있을 것:
  - `if (!this.stateChanged) return;`
  - 업로드 성공 후 `this.stateChanged = false;`

수정:
- uploadStateToR2 시작 직전에:
  - `const v = this.stateVersion;` 를 저장
- 업로드 성공 후 stateChanged=false 처리할 때:
  - `if (this.stateVersion === v) this.stateChanged = false;`
  - (버전이 달라졌으면 false로 덮지 말고 유지)

================================================================================
[5] 백엔드: R2 cache-control 완화 (재검증 빈도↓ → 비용↓)
================================================================================
파일: egg-backend/src/gameDO.ts

앵커 E(필수):
- `this.env.STATE_BUCKET.put(` 호출 부분을 찾아라.
- 그 객체 옵션에 아래가 있을 것이다:
  - `cacheControl: "public, max-age=5, stale-while-revalidate=30"`

수정:
- 아래로 변경(권장):
  - `cacheControl: "public, max-age=20, stale-while-revalidate=120"`
(프론트 폴링을 45초로 올리는 조건과 잘 맞음)

================================================================================
[산출물/검증]
================================================================================
1) 변경된 파일 목록
2) 각 변경의 핵심 diff 요약(수정 전/후 라인 중심)
3) 수동 테스트 체크리스트:

A. 관전 폴링
- visible에서 pollingMode가 active이고, 요청 간격이 45초 근처인지
- hidden 10분 후 3분, 60분 후 5분으로 느려지는지
- hidden 2시간 후 paused(절전)로 전환되는지
- visible로 돌아오면 1회 즉시 fetch 후 active로 복귀하는지
- visible 상태에서 2시간 무인터랙션이어도 즉시 paused 되지 않고(8시간 기준) 유지되는지

B. 서버 cleanup 반영
- 대기열 유휴 30분 / 플레이어 유휴 10분 시 정리되는지
- 정리 직후 관전자 화면에 onlinePlayers/queueLength가 늦지 않게 반영되는지(broadcastState 포함)

C. stateChanged 경합
- 업로드 직전/직후 상태 변경이 연속으로 일어나도 R2 state.json 갱신이 누락되지 않는지(stateVersion으로 보호)

변경 완료 후 타입스크립트/빌드 에러 없는지 확인해.
