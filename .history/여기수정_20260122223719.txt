너는 이 레포(worldegg-breaking-main)의 프론트/백엔드를 수정하는 코드리뷰+패치 담당자다.
내 목표:
- 접속자 1000, 대기자 1000, 관전자 98000까지 운영
- 10만명 관전 기준 월 4~5만원 수준으로 비용 안정화
- 아래 버그/보안 문제를 해결

[버그 1: 대기자 안내 문구]
파일: egg-breaker/src/components/GameArea.jsx
함수: getGuideText()

현재 로직에서
if (serverState.onlinePlayers >= MAX_PLAYERS && !connected) 가 너무 먼저 실행되어,
대기열이 남아있어도 "현재 참가자와 대기자가 꽉차 있습니다! (관전중)"만 뜬다.

요구사항:
- 플레이어가 꽉 찼더라도(queueLength < MAX_QUEUE) 이면
  "대기자니까 다음 게임에 참가할수 있습니다!" 문구가 뜨게 해라.
- "관전중(꽉참)" 문구는 (onlinePlayers >= MAX_PLAYERS && queueLength >= MAX_QUEUE) 일 때만 뜨게 해라.
- 이미 queuePos가 있는 경우(isQueueActive)는 최우선으로 대기 메시지를 보여라.

구현 시 주의:
- MAX_PLAYERS, MAX_QUEUE는 serverState.maxPlayers/maxQueue가 없으면 각각 1000으로 폴백
- 조건 순서를 재배치하거나, 기존 FULL 조건에 queueLength 체크를 추가해 정확히 동작시켜라.

[버그 2: 공유 취소 반복으로 포인트 중복지급]
프론트: egg-breaker/src/App.jsx
현재는 share 버튼 클릭만으로 보상 지급을 제거했고, 친구가 링크로 접속했을 때만 보상하도록 바뀐 걸로 보인다.
- 이 의도가 유지되도록 확인해라.
- "친구당 1번"을 영구 1번으로 할지/라운드당 1번으로 할지 선택 가능하게 설계하라:
  - 영구 1번이면 admin/reset-round에서 invites 테이블 DELETE를 제거
  - 라운드당 1번이면 현재 유지
둘 중 현재 코드는 무엇인지 설명하고, 내가 원하는 모드로 쉽게 바꿀 수 있게 옵션화(주석/설정) 제안해라.

[치명 보안: /api/state가 우승 토큰/시크릿을 노출]
파일: egg-backend/src/gameDO.ts
엔드포인트: /state 응답이 { ...this.gameState }라서
winningToken, winningClientId, prizeSecretUrl 같은 민감정보가 노출된다.
요구사항:
- /state는 R2에 올리는 publicState와 동일한 "화이트리스트 필드"만 반환해라.
- 우승 토큰/시크릿(prizeSecretUrl)은 오직 winner에게만 websocket you_won 메시지로 전달되게 유지해라.
- 필요하다면 publicState 만드는 공통 함수(예: buildPublicState())로 /state, broadcastState, R2 업로드에서 재사용해라.

[비용 최적화]
1) 관전자 폴링:
파일: egg-breaker/src/hooks/useGameState.js
현재 R2 폴링 기본이 10초다.
요구사항:
- 관전(connected=false)일 때 기본 폴링을 20~30초로 늘려라.
- document.visibilityState가 hidden이면 60초 이상으로 느리게 해라.
- jitter는 유지해서 thundering herd 방지해라.
- 게임이 FINISHED가 아닌 PLAYING일 때만 좀 더 자주(예: 20초), FINISHED면 더 느리게(예: 60초) 같은 적응형도 가능하면 적용해라.

2) R2 업로드:
파일: egg-backend/src/gameDO.ts
현재 3초마다 무조건 PUT한다.
요구사항:
- 상태가 실제로 변경되었을 때만 업로드하도록 stateChanged 플래그를 제대로 도입해라.
- hp 변화, status 변화, announcement/config 변화, round reset 등에서 stateChanged=true로 설정.
- 업로드 성공 시 stateChanged=false로 reset.
- 업로드 루프는 5~10초로 완화하되, 상태 변경이 있으면 다음 틱에 업로드되게 해라.

[산출물]
- 위 변경사항을 모두 반영한 patch/diff를 제시하고
- 왜 이 변경이 내 비용 목표(10만 관전 월 4~5만원)에 유리한지,
  어떤 요청/오퍼레이션이 줄어드는지 정량적으로 설명해라.
- 추가로, 대규모 트래픽에서 버그 날만한 부분 5가지를 찾아서 우선순위로 제시해라.
