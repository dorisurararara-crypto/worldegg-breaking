너는 내 레포(worldegg-breaking-main.zip) 기반으로 수정해줘. 
목표는 2가지 버그/악용 방지야. “직접 코드를 고치고 커밋 가능한 상태”로 만들어줘. 
수정 후 로컬/배포에서 동작 검증 체크리스트까지 제공해.

========================
[문제 1] 대기자 안내 문구가 잘못 나옴
========================
상황:
- 접속자(참가자) 1000, 대기자 500, 관전자 98000 같은 대규모를 목표로 테스트 중.
- 관리자 페이지(#admin)에서 fakePlayers=1000, fakeQueue=500으로 세팅하면,
  “대기자니까 다음 게임에 참가할수 있습니다!” 문구가 떠야 하는데,
  지금은 “현재 참가자와 대기자가 꽉차 있습니다! (관전중)”만 뜸.

원인:
- 프론트 GameArea의 guideText 로직이 queueLength(fakeQueue)를 고려하지 않고,
  onlinePlayers>=1000 && !connected 조건만으로 “꽉참(관전중)”을 띄움.
- fakeQueue=500이면 “대기열 자리가 남아있음”이므로 관전 문구가 아니라 “대기 가능” 문구가 떠야 함.

해야 할 수정(프론트):
1) 파일: egg-breaker/src/components/GameArea.jsx
2) 앵커: `// Guide Text Logic` 블록(현재 코드에 아래처럼 있음)
   - `if (isQueueActive) { guideText = "다음 게임에 참가할수 있습니다!"; }`
   - `else if (serverState.onlinePlayers >= 1000 && !connected) { guideText = "현재 참가자와 대기자가 꽉차 있습니다! (관전중)"; }`
3) 위 로직을 “queueLength 포함”으로 바꿔줘.
   - MAX_PLAYERS=1000, MAX_QUEUE=1000 기준(백엔드 상수와 동일)
   - serverState.queueLength(=fakeQueue 반영)를 사용해서 분기:
     A. onlinePlayers >= MAX_PLAYERS && queueLength < MAX_QUEUE && !connected
        => guideText = "대기자니까 다음 게임에 참가할수 있습니다!" (또는 기존 문구 "다음 게임에 참가할수 있습니다!" 유지해도 됨)
     B. onlinePlayers >= MAX_PLAYERS && queueLength >= MAX_QUEUE && !connected
        => guideText = "현재 참가자와 대기자가 꽉차 있습니다! (관전중)"
     C. 그 외 spectator/connected 분기는 기존 동작 유지
4) (권장) 하드코딩을 줄이려면 백엔드 state payload에 maxPlayers/maxQueue를 추가하고,
   프론트는 serverState.maxPlayers/maxQueue를 우선 사용하도록 개선해줘.
   - 백엔드 파일: egg-backend/src/gameDO.ts
   - 앵커: broadcastState payload(JSON.stringify({...}))에 maxPlayers/maxQueue 추가
   - 앵커: `/state` 응답에도 포함

========================
[문제 2] 카카오 공유 포인트 악용
========================
현재 악용 시나리오(유저가 재현):
- 카카오 공유하기 버튼 누르고, 실제 공유 안 하고 닫기만 해도 “공유하기완료!”가 뜸.
- 이렇게 5번 반복 후, 마지막에 진짜 친구에게 공유 → 친구가 들어오면 800*5=4000 포인트가 들어옴.
요구사항:
- “친구 1명당 1회”만 보상.
- “본인에게 공유(셀프 추천)”는 막고 싶음.
- 공유 버튼 닫기/취소만으로는 보상이 쌓이면 안 됨.

현재 코드 위치(프론트):
- 파일: egg-breaker/src/App.jsx
- 앵커: `const handleKakaoShare = async () => { ... }`
  여기서 shareCount를 버튼 클릭/닫기로 증가시키고 있음:
  `setShareCount(prev => prev + 1);`
- 초대 보상 검증은 링크 유입 시 실행:
  App.jsx의 `// Handle Invite Link Check` useEffect에서 `/api/invite-reward`로 POST
- 백엔드 처리:
  파일: egg-backend/src/gameDO.ts
  앵커: `if (url.pathname === "/invite-reward" && request.method === "POST") { ... }`
  지금은 invites(from_user,to_user,date)만 있고, self(from===to)만 막음.

해야 할 수정(핵심 원칙):
- “공유 UI를 열었다/닫았다”는 신뢰 불가 → 보상 근거로 쓰지 말 것.
- 보상은 “실제로 링크를 타고 들어온 신규/다른 사용자”가 감지될 때만 1회 지급.
- 서버에서 중복/셀프/악용을 더 강하게 막아야 함(클라이언트만 믿지 말 것).

구체 수정안(프론트):
A) shareCount 의미 변경(필수)
1) 파일: egg-breaker/src/App.jsx
2) 앵커: handleKakaoShare 내부에서 아래 제거 또는 변경:
   - `setShareCount(prev => prev + 1);`  ← 이건 없애고,
   - 공유창을 열었으면 “공유창이 열렸어요. 친구가 링크로 접속하면 800P 지급” 같은 안내만 띄우기.
3) shareCount는 “성공적으로 invite_reward 받은 횟수(=실제 친구 유입 보상 횟수)”로만 증가시켜.
   - 파일: egg-breaker/src/App.jsx
   - 앵커: `// Handle Reward Events (Invites)` useEffect(rewardEvent)
   - rewardEvent.msg가 INVITE_REWARD_MSG / INVITE_REWARD_WELCOME 인 경우에만:
     `setShareCount(prev => prev + 1);`
   - 그리고 shareCount 상한(5회)을 프론트 안내용으로만 사용(서버 제한이 최종)
4) (중요) 현재 “공유하기완료! (x/5)”는 오해 유발이니,
   “초대 보상 누적 (x/5)” 같은 의미로 문구 변경(TRANSLATIONS도 있으면 함께 수정).

B) 링크 유입 중복 호출/중복 지급 방지(권장)
1) 파일: egg-breaker/src/App.jsx
2) 앵커: `// Handle Invite Link Check` useEffect에서 localStorage 체크키가
   현재: `egg_invite_checked_${referrer}_r${currentRound}`
   이러면 “to(현재 유입자)”가 바뀌거나 멀티탭/딥링크로 중복 호출될 여지가 있음.
3) 체크키를 아래처럼 더 엄격하게 바꿔:
   `egg_invite_checked_${referrer}_${clientId}_r${currentRound}`
   (또는 date도 포함)
4) Capacitor deep link(appUrlOpen)에서도 같은 URL이 연속으로 들어오면 중복 처리되지 않게
   마지막 처리 URL을 ref로 저장해 중복 실행 방지.

구체 수정안(백엔드: 악용 방지 강화):
목표:
- “친구 1명당 1회”: 이미 from_user+to_user 중복은 막고 있으나,
  ‘셀프 공유’나 ‘같은 사람이 다른 clientId로 계속’ 같은 케이스를 더 막아야 함.
- 최소한 “같은 IP/UA로 반복 유입”은 같은 사람 가능성이 높으니 보상 1회로 제한.

C) invites 테이블 스키마 확장(필수 권장)
1) 파일: egg-backend/schema.sql
2) invites 테이블을 아래 컬럼 포함하도록 변경:
   - from_user TEXT
   - to_user TEXT
   - date TEXT
   - to_ip_hash TEXT
   - to_ua_hash TEXT
   - created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
3) UNIQUE 제약 추가(중복 지급 차단):
   - UNIQUE(from_user, to_user)
   - UNIQUE(from_user, date, to_ip_hash)
   (원하면 ua_hash도 포함 가능: UNIQUE(from_user, date, to_ip_hash, to_ua_hash))
4) index도 추가하면 좋음:
   - INDEX invites_from_date_idx (from_user, date)
   - INDEX invites_from_ip_idx (from_user, date, to_ip_hash)

D) invite-reward 로직 강화(필수)
1) 파일: egg-backend/src/gameDO.ts
2) 앵커: `/invite-reward` POST 핸들러
3) request.headers에서 아래 추출:
   - ip = CF-Connecting-IP (없으면 "unknown")
   - ua = User-Agent (없으면 "unknown")
4) ip/ua는 원문 저장 말고 해시(SHA-256)로 저장:
   - to_ip_hash = sha256(ip)
   - to_ua_hash = sha256(ua)
5) DB 체크 로직 변경:
   - 기존 pair_exists(from_user,to_user)는 유지
   - 여기에 “동일 from_user + 동일 date + 동일 to_ip_hash” 중복이면 400으로 차단
6) INSERT 시 to_ip_hash/to_ua_hash도 함께 저장
7) 만약 referrer(from)가 현재 접속 중이면, referrer의 세션 ip를 저장해뒀다가
   request ip가 referrer ip와 같으면 “셀프 공유 의심”으로 400 차단(옵션).
   - 이를 위해 WebSocket join 시 session.ip가 지금 "unknown"으로 저장되는 버그도 고쳐줘.
   - 파일: egg-backend/src/gameDO.ts
   - 앵커: handleSession(ws, ip, requestedMode)에서 ws->ip를 임시로 보관하고,
     webSocketMessage의 join 처리에서 session.ip에 실제 ip를 넣도록 수정.
   - 단, 같은 와이파이(가족/회사)에서 친구 초대까지 막힐 수 있으니
     이 규칙은 “옵션 플래그(ENV로 on/off)”로 만들거나,
     최소한 “to_user가 referrer와 동일 clientId가 아니어도 IP 같으면 막기”는 신중히 적용해.

E) admin reset-round에서 invites 테이블 생성 로직 업데이트(필수)
- 파일: egg-backend/src/gameDO.ts
- 앵커: reset-round에서 invites 테이블 없을 때 CREATE TABLE IF NOT EXISTS invites ... 하는 부분
- 여기 스키마도 위에서 바꾼 새 invites 스키마/UNIQUE 제약과 일치시켜줘.

========================
[검증 체크리스트]
========================
1) #admin에서 fakePlayers=1000, fakeQueue=500 세팅 후:
   - 접속 전 화면 가이드가 “대기 가능” 문구로 뜨는지
2) #admin에서 fakePlayers=1000, fakeQueue=1000 세팅 후:
   - “참가자와 대기자가 꽉차 있습니다! (관전중)” 문구가 뜨는지
3) 카카오 공유:
   - 공유창 열고 그냥 닫아도 포인트/초대카운트가 증가하지 않는지
   - 친구가 링크로 1번 들어오면 +800P 정확히 1회만 들어오는지
   - 같은 친구(같은 브라우저/기기)로 재접속/새로고침해도 추가 지급이 안 되는지
   - (추가) 같은 IP/UA에서 반복 유입 시도 시 추가 지급이 막히는지(정책대로)

마지막으로, 변경된 파일 목록과 주요 diff 요약을 같이 출력해줘.
